<!DOCTYPE html>
<html>
<head>
    <style>
        body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
        iframe, #player { width: 100vw; height: 100vh; border: none; display: block; }
    </style>
</head>
<body>
    <div id="player"></div>

    <script>
        // --- 1. CONFIGURATION & MODE TEST ---
        const params = new URLSearchParams(window.location.search);
        
        let videoId = params.get('v');
        let videoType = params.get('type');
        let startTime = params.get('t') || 0;

        // MODE TEST AUTO : Si aucune URL n'est fournie, on lance une vidéo démo
        if (!videoId) {
            console.log("MODE TEST: Aucune vidéo spécifiée, lancement du test.");
            videoId = "LXb3EKWsInQ"; // 4K Nature (Costa Rica)
            videoType = "youtube";
        }

        const container = document.getElementById('player');
        let twitchPlayer = null;

        // --- 2. LOGIQUE YOUTUBE (VIA INVIDIOUS / STYLE FREETUBE) ---
        if (videoType === 'youtube') {
            const iframe = document.createElement('iframe');
            
            // Utilisation de 'yewtu.be' (Instance Invidious très stable)
            // autoplay=1 : Lecture auto
            // controls=0 : Masque l'interface
            // loop=1 : Boucle (optionnel, souvent mieux pour l'ambiance)
            // related_videos=0 : Pas de suggestions à la fin
            const backendUrl = "https://yewtu.be"; 
            
            iframe.src = `${backendUrl}/embed/${videoId}?autoplay=1&controls=0&loop=1&related_videos=0&t=${startTime}`;
            iframe.allow = "autoplay; fullscreen";
            
            container.appendChild(iframe);
        }

        // --- 3. LOGIQUE TWITCH ---
        else if (videoType === 'twitch') {
            const script = document.createElement('script');
            script.src = "https://player.twitch.tv/js/embed/v1.js";
            
            script.onload = () => {
                const options = {
                    width: '100%',
                    height: '100%',
                    channel: videoId,
                    layout: "video", // Cache le chat
                    autoplay: true,
                    parent: ["localhost", window.location.hostname] 
                };
                twitchPlayer = new Twitch.Player("player", options);
            };
            document.head.appendChild(script);
        }

        // --- 4. GESTION DES COMMANDES (NUI FIVEM) ---
        window.addEventListener('message', function(event) {
            const data = event.data;
            if (!data) return;

            // Commandes Twitch
            if (videoType === 'twitch' && twitchPlayer) {
                if (data.action === 'volume') twitchPlayer.setVolume(data.value / 100);
                if (data.action === 'pause') twitchPlayer.pause();
                if (data.action === 'play') twitchPlayer.play();
                if (data.action === 'stop') container.innerHTML = '';
            }

            // Commandes Invidious/YouTube
            // Note: Le contrôle iframe cross-origin est limité. 
            // Le STOP supprime l'élément pour garantir l'arrêt du son.
            if (videoType === 'youtube') {
                if (data.action === 'stop') {
                    container.innerHTML = ''; 
                }
            }
        });
    </script>
</body>
</html>
