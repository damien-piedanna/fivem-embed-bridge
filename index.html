<!DOCTYPE html>
<html>
<head>
    <style>
        body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
        iframe, #player { width: 100vw; height: 100vh; border: none; display: block; }
    </style>
</head>
<body>
    <div id="player"></div>

    <script>
        const proxyUrl = "https://invidious.snopyta.org";

        const params = new URLSearchParams(window.location.search);
        let videoId = params.get('v');
        let videoType = params.get('type');
        let startTime = params.get('t') || 0;

        const container = document.getElementById('player');
        let twitchPlayer = null;

        if (!videoId) {
            console.log("MODE TEST ACTIVÉ");
            videoId = "LXb3EKWsInQ"; // Costa Rica 4K
            videoType = "youtube";
        }

        if (videoType === 'youtube') {
            const iframe = document.createElement('iframe');
            
            // Construction URL Piped
            // autoplay=1 : Lecture auto
            // controls=0 : Interface cachée
            // modestbranding=1 : Propre
            // iv_load_policy=3 : Pas d'annotations
            iframe.src = `${proxyUrl}/embed/${videoId}?autoplay=1&controls=0&modestbranding=1&iv_load_policy=3&time=${startTime}`;
            
            iframe.allow = "autoplay; encrypted-media; picture-in-picture";
            container.appendChild(iframe);
        }

        // --- 4. LOGIQUE TWITCH ---
        else if (videoType === 'twitch') {
            const script = document.createElement('script');
            script.src = "https://player.twitch.tv/js/embed/v1.js";
            
            script.onload = () => {
                const options = {
                    width: '100%',
                    height: '100%',
                    channel: videoId,
                    layout: "video",
                    autoplay: true,
                    // "parent" est crucial pour Twitch. Ajoute ton domaine si ce n'est pas localhost.
                    parent: ["localhost", "127.0.0.1", window.location.hostname] 
                };
                twitchPlayer = new Twitch.Player("player", options);
            };
            document.head.appendChild(script);
        }

        // --- 5. GESTION DES COMMANDES (FIVEM NUI) ---
        window.addEventListener('message', function(event) {
            const data = event.data;
            if (!data) return;

            // Twitch (Contrôle total)
            if (videoType === 'twitch' && twitchPlayer) {
                if (data.action === 'volume') twitchPlayer.setVolume(data.value / 100);
                if (data.action === 'pause') twitchPlayer.pause();
                if (data.action === 'play') twitchPlayer.play();
                if (data.action === 'stop') container.innerHTML = '';
            }

            // YouTube (Piped)
            if (videoType === 'youtube') {
                if (data.action === 'stop') {
                    container.innerHTML = ''; // Arrêt brutal pour couper le son
                }
            }
        });
    </script>
</body>
</html>

